SELECT
    PURCHASEORDER.ID,
    CASE PURCHASEORDER.STATUSID
        WHEN 0 THEN 'Pendente'
        WHEN 1 THEN 'Parc. Recebido'
        WHEN 2 THEN 'Recebido'
        WHEN 3 THEN 'Cancelado'
    END AS 'Status',
    CASE PURCHASEORDER.SITUATIONID
        WHEN 0 THEN 'Não Aprovado'
        WHEN 1 THEN 'Aprovado'
    END AS 'Situação',
    STRFTIME('%d/%m/%Y', PURCHASEORDER.CREATIONDATE) As 'Data',
    QUOTATION.ID AS 'Cotação',
    COSTSHARING.NAME AS 'Centro de Custo',
    PERSON.NAME AS 'Fornecedor',
    PURCHASEORDER.CONTACT AS 'Contato',
    PURCHASEORDER.PHONE AS 'Telefone',
    PURCHASEORDER.EMAIL AS 'E-Mail',
    PAYMENTTERM.NAME AS 'Pagamento',
    CASE PURCHASEORDER.CARRIERTYPEID
        WHEN 0 THEN 'Sem Frete'
        WHEN 1 THEN 'CIF'
        WHEN 2 THEN 'FOB'
        WHEN 3 THEN 'Terceiro'
    END AS 'Tipo Frete',
    PERSON.NAME AS 'Transportadora',    
    SUM(CAST(PURCHASEORDERITEM.IPI AS REAL)/100*((PURCHASEORDERITEM.QUANTITY/100)*(PURCHASEORDERITEM.PRICE/100))+(PURCHASEORDERITEM.QUANTITY/100)*(PURCHASEORDERITEM.PRICE/100))+(PURCHASEORDER.CARRIERPRICE/100) +(PURCHASEORDER.EXPENSE/100)+(PURCHASEORDER.ICMSST/100)  AS 'Valor Bruto',
    SUM(CAST(PURCHASEORDERITEM.IPI AS REAL)/100*((PURCHASEORDERITEM.QUANTITY/100)*(PURCHASEORDERITEM.PRICE/100))+(PURCHASEORDERITEM.QUANTITY/100)*(PURCHASEORDERITEM.PRICE/100)-(PURCHASEORDERITEM.DISCOUNT/100))+(PURCHASEORDER.CARRIERPRICE/100) +(PURCHASEORDER.EXPENSE/100)+(PURCHASEORDER.ICMSST/100)-(PURCHASEORDER.DISCOUNT/100)  AS 'Valor Líquido',   
    STRFTIME('%d/%m/%Y', PURCHASEORDER.INITIALDELIVERY) AS 'Prev. Entrega',
    STRFTIME('%d/%m/%Y', PURCHASEORDER.FINALDELIVERY) AS 'Entrega',
    PURCHASEORDER.EXTERNALNOTE AS 'Observação Externa',
    PURCHASEORDER.INTERNALNOTE AS 'Observação Interna'
FROM PURCHASEORDER
LEFT JOIN QUOTATION ON QUOTATION.ID = PURCHASEORDER.QUOTATIONID
LEFT JOIN COSTSHARING ON COSTSHARING.ID = PURCHASEORDER.COSTSHARINGID
LEFT JOIN PERSON ON PERSON.ID = PURCHASEORDER.PERSONID
LEFT JOIN PERSON AS CARRIER ON CARRIER.ID = PURCHASEORDER.CARRIERID
LEFT JOIN PAYMENTTERM ON PAYMENTTERM.ID = PURCHASEORDER.PAYMENTTERMID
LEFT JOIN PURCHASEORDERITEM ON PURCHASEORDERITEM.PURCHASEORDERID = PURCHASEORDER.ID
LEFT JOIN ITEM ON ITEM.ID = PURCHASEORDERITEM.ITEMID
WHERE
    IFNULL(PURCHASEORDER.ID, '') LIKE @ID AND
    IFNULL(PURCHASEORDER.STATUSID, '') LIKE @STATUSID AND
    IFNULL(PURCHASEORDER.SITUATIONID, '') LIKE @SITUATIONID AND
    IFNULL(PURCHASEORDER.QUOTATIONID, '') LIKE @QUOTATION AND
    IFNULL(COSTSHARING.NAME, '') LIKE @COSTSHARING AND
    IFNULL(PERSON.ID, '') LIKE @PERSONID AND
    IFNULL(PERSON.DOCUMENT1, '') LIKE @PERSONDOCUMENT AND
    IFNULL(PERSON.NAME, '') LIKE @PERSONNAME AND
    IFNULL(ITEM.ID, '') LIKE @ITEMID AND
    IFNULL(ITEM.NAME, '') LIKE @ITEMNAME AND
    IFNULL(PURCHASEORDERITEM.COMPLEMENT, '') LIKE @ITEMCOMPLEMENT AND
    IFNULL(PURCHASEORDER.CONTACT, '') LIKE @PERSONCONTACT AND
    IFNULL(PURCHASEORDER.PHONE, '') LIKE @PERSONPHONE AND
    IFNULL(PURCHASEORDER.EMAIL, '') LIKE @PERSONEMAIL AND
    IFNULL(PAYMENTTERM.NAME, '') LIKE @PAYMENTTERM AND
    IFNULL(PURCHASEORDER.CARRIERTYPEID, '') LIKE @CARRIERTYPE AND
    IFNULL(CARRIER.NAME, '') LIKE @CARRIER AND
    IFNULL(PURCHASEORDER.EXTERNALNOTE, '') LIKE @EXTERNALNOTE AND
    IFNULL(PURCHASEORDER.INTERNALNOTE, '') LIKE @INTERNALNOTE AND
    PURCHASEORDER.INITIALDELIVERY BETWEEN @INITIALDELIVERYI AND @INITIALDELIVERYF AND
    IFNULL(PURCHASEORDER.FINALDELIVERY, '9999-12-31') BETWEEN @FINALDELIVERYI AND @FINALDELIVERYF AND
    PURCHASEORDER.CREATIONDATE BETWEEN @CREATIONDATEI AND @CREATIONDATEF
GROUP BY 
    PURCHASEORDER.ID
HAVING
    SUM(CAST(PURCHASEORDERITEM.IPI AS REAL)/100*((PURCHASEORDERITEM.QUANTITY/100)*(PURCHASEORDERITEM.PRICE/100))+(PURCHASEORDERITEM.QUANTITY/100)*(PURCHASEORDERITEM.PRICE/100)-(PURCHASEORDERITEM.DISCOUNT/100))+(PURCHASEORDER.CARRIERPRICE/100) +(PURCHASEORDER.EXPENSE/100)+(PURCHASEORDER.ICMSST/100)-(PURCHASEORDER.DISCOUNT/100) BETWEEN CAST(@ORDERVALUEMIN AS REAL) AND CAST(@ORDERVALUEMAX AS REAL)
LIMIT 1000;